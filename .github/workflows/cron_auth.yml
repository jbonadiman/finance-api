name: auth-refresh

on:
  schedule:
    - cron: '*/45 * * * *'

  workflow_dispatch:

jobs:
  cron:
    runs-on: ubuntu-latest

    steps:
      - name: Call the authentication endpoint to refresh the token
        id: authRun
        run: |
          curl -X GET -LGI \
          --url "https://login.microsoftonline.com/consumers/oauth2/v2.0/authorize" \
           --data client_id="$MS_CLIENT_ID" \
           --data-urlencode redirect_uri="$MS_REDIRECT" \
           --data response_type="code" \
           --data scope="offline_access+tasks.readwrite" \
           --data state="12345" \
           -o "response.out"
        shell: bash
        env:
          MS_CLIENT_ID: ${{ secrets.MS_CLIENT_ID }}
          MS_REDIRECT: ${{ secrets.MS_REDIRECT }}
      
      - uses: pCYSl5EDgo/cat@master
        id: getsResponseFile
        with:
          path: response.out

      - uses: logflare/action@v1
        id: stats
        with:
          api_key: ${{ secrets.LOGFLARE_API_KEY }}
          source_id: ${{ secrets.LOGFLARE_SOURCE_ID }}
          message:  Called authentication endpoint
          metadata: |
            {
              "version": "0.0.1"
              "response": ${{ steps.getsResponseFile.outputs.text }}
            }
